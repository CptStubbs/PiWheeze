<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CO₂ Sensor Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <h1>Live Sensor Data</h1>

    <div>
        <strong>CO₂:</strong> <span id="co2">--</span> ppm<br>
        <strong>Temperature:</strong> <span id="temp">--</span> °C<br>
        <strong>Humidity:</strong> <span id="humidity">--</span> %
    </div>

    <h2>History (Last 7 Days)</h2>
    <canvas id="co2Chart" width="800" height="300"></canvas>

    <script>
        /* ---------- Chart setup ---------- */
        const ctx = document.getElementById('co2Chart').getContext('2d');

        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'CO₂ ppm',
                    data: [],
                    borderWidth: 2,
                    tension: 0.2
                }]
            },
            options: {
                animation: false,
                responsive: true,
                parsing: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            tooltipFormat: 'yyyy-MM-dd HH:mm',
                            displayFormats: {
                                hour: 'HH:mm',
                                day: 'MMM d'
                            }
                        },
                        title: { display: true, text: 'Time (UTC)' }
                    },
                    y: {
                        title: { display: true, text: 'CO₂ ppm' }
                    }
                }
            }
        });

        /* ---------- Live data ---------- */
        async function updateLive() {
            const res = await fetch('/current');
            if (!res.ok) return;

            const data = await res.json();

            document.getElementById('co2').textContent = data.co2_ppm.toFixed(1);
            document.getElementById('temp').textContent = data.temperature.toFixed(1);
            document.getElementById('humidity').textContent = data.humidity.toFixed(1);
        }

        /* ---------- History chart ---------- */
        async function updateChart() {
            const res = await fetch('/history');
            const data = await res.json();

            chart.data.datasets[0].data = data.map(d => ({
                x: d.timestamp,   // ISO 8601 UTC string
                y: d.co2_ppm
            }));

            chart.update();
        }

        /* ---------- Timers ---------- */
        updateLive();
        updateChart();

        setInterval(updateLive, 5000);      // live values
        setInterval(updateChart, 60000);    // history refresh
    </script>

</body>
</html>
